<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Reporte Historias INVEST</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f6fa;
      }
      h1 {
        text-align: center;
        margin-bottom: 30px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(900px, 1fr));
        gap: 20px;
      }
      .card {
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        display: flex;
        flex-direction: column;
      }
      .card h2 {
        margin: 0 0 10px 0;
        font-size: 18px;
        color: #2c3e50;
      }
      .badges {
        margin: 10px 0;
      }
      .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 8px;
        margin-right: 8px;
        font-size: 13px;
        color: #fff;
      }
      .badge.complejidad {
        background: #e67e22;
      }
      .badge.estimacion {
        background: #3498db;
      }
      .invest {
        font-size: 14px;
        margin-top: 10px;
        white-space: pre-line;
      }
      canvas {
        margin-top: 15px;
        width: 100% !important;
        max-height: 400px;
      }
    </style>
  </head>
  <body>
    <h1>游늵 Historias INVEST</h1>
    <div id="cards" class="grid"></div>

    <script>
      fetch("/data")
        .then((r) => r.json())
        .then((data) => {
          init(data);
        });

      function init(data) {
        function parseInvestScores(text) {
          const criterios = [
            "Independiente",
            "Negociable",
            "Valiosa",
            "Estimable",
            "Peque침a",
            "Testeable",
          ];
          const scores = [];
          criterios.forEach((c) => {
            const regex = new RegExp(c + "\\s*\\(\\s*(\\d+)\\s*\\)", "i");
            const match = text.match(regex);
            scores.push(match ? parseInt(match[1]) : 0);
          });
          return scores;
        }

        const cardsDiv = document.getElementById("cards");
        const count = data.length;
        const cols = Math.ceil(Math.sqrt(count));

        data.forEach((historia, i) => {
          // === Parser de valores INVEST (busca n칰meros entre par칠ntesis) ===
          const card = document.createElement("div");
          card.className = "card";

          // T칤tulo
          const title = document.createElement("h2");
          title.textContent = historia.titulo;
          card.appendChild(title);

          // Badges
          const badges = document.createElement("div");
          badges.className = "badges";
          badges.innerHTML = `
            <span class="badge estimacion">Estimaci칩n: ${historia.estimacion_dias} d칤as</span>
            <span class="badge complejidad">Complejidad: ${historia.complejidad}</span>
          `;
          card.appendChild(badges);
          // Mini gr치fico radar INVEST
          // Crear tarjeta HU
          const card_c = document.createElement("div");
          card_c.className = "card2";
          card_c.style.display = "flex"; // Flex para dividir espacio
          card_c.style.gap = "20px"; // Espacio entre canvas y panel
          card_c.style.alignItems = "flex-start"; // Alinear arriba

          // Contenedor del canvas (70%)
          const canvasContainer = document.createElement("div");
          canvasContainer.style.flex = "0.6"; // 70% ancho fijo
          const canvas = document.createElement("canvas");
          canvas.id = "chart-" + i;
          canvasContainer.appendChild(canvas);

          // Contenedor HTML custom (30%)
          const htmlContainer = document.createElement("div");
          htmlContainer.style.flex = "0.5";
          htmlContainer.style.padding = "10px";
          htmlContainer.style.maxHeight = "350px";
          htmlContainer.style.overflowY = "auto";
          const content = marked.parse(historia.invest);
          htmlContainer.innerHTML = `<h3>Detalles</h3>
                          ${content}`;

          // A침adir ambos al card
          card_c.appendChild(canvasContainer);
          card_c.appendChild(htmlContainer);
          cardsDiv.appendChild(card);
          card.appendChild(card_c);

          // Parsear scores e inicializar radar chart
          const scores = parseInvestScores(historia.invest);

          new Chart(canvas, {
            type: "radar",
            data: {
              labels: [
                "Independiente",
                "Negociable",
                "Valiosa",
                "Estimable",
                "Peque침a",
                "Testeable",
              ],
              datasets: [
                {
                  label: "INVEST",
                  data: scores,
                  backgroundColor: "rgba(52, 152, 219, 0.2)",
                  borderColor: "#3498db",
                  pointBackgroundColor: "#3498db",
                },
              ],
            },
            options: {
              scales: { r: { min: 0, max: 5, ticks: { stepSize: 1 } } },
              plugins: { legend: { display: false } },
              responsive: true,
              maintainAspectRatio: false,
            },
          });
        });
      }
    </script>
  </body>
</html>
